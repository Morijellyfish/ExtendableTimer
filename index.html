<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>旋律タイマー</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>旋律タイマー</h1>
    <div style="margin-bottom: 20px; color: #888; font-size: 14px;">
        ※各タイマーごとに「初回値」「延長値」を変更できます。
    </div>

    <div style="margin-bottom: 20px;">
        <label>狩猟笛テンプレート:
            <select id="templateSelect">
                <option value="">--選択--</option>
            </select>
        </label>
        <label style="margin-left:16px;">
            <input type="checkbox" id="fuefukiCheckbox"> 笛吹き名人
        </label>
        <button id="applyTemplateBtn">適用</button>
    </div>
    <div id="hornColors" style="margin-bottom:16px;"></div>
    <div id="timers"></div>

    <script src="template.js"></script>
    <script>
        // 旋律クラス
        class Melody {
            constructor(index, name = '', effectDuration = 180, extendDuration = 90) {
                this.index = index;
                this.name = name;
                this.effectDuration = effectDuration;
                this.extendDuration = extendDuration;
                this.timer = 0;
            }

            reset() {
                this.timer = 0;
                this.updateUI();
            }

            addTime() {
                if (this.timer === 0) {
                    this.timer = this.effectDuration;
                } else {
                    this.timer = Math.min(this.effectDuration, this.timer + this.extendDuration);
                }
                this.updateUI();
            }

            updateUI() {
                document.getElementById(`time-${this.index}`).textContent = this.timer;
            }

            render(container) {
                const div = document.createElement("div");
                div.className = "timer";
                div.id = `timer-${this.index}`;

                const createNotesHtml = (notes) => {
                    if (!(notes && this.name)) return '';
                    const maxNotes = 4;
                    const emptyCount = maxNotes - notes.length;
                    let html = `<span class="note-icons" style="display:flex;justify-content:flex-start;align-items:center;width:100px;min-width:80px;vertical-align:middle;margin-left:10px;">`;
                    for (let i = 0; i < emptyCount; i++) {
                        html += `<span style="display:inline-block;width:22px;height:22px;margin-left:2px;"></span>`;
                    }
                    for (let i = 0; i < notes.length; i++) {
                        const c = notes[i];
                        const color = getHornColorCode(c);
                        let borderColor = '#222';
                        if (c === '白' || c === '黄' || c === '空') borderColor = '#888';
                        html += `<span title="${c}" style="display:inline-block;width:22px;height:22px;border-radius:50%;background:${color};border:2px solid ${borderColor};margin-left:2px;vertical-align:middle;"></span>`;
                    }
                    html += `</span>`;
                    return html;
                };

                const createTimerRowHtml = (notesHtml) => {
                    return `
                            <div style="display:flex;align-items:center;">
                                <label>[${this.index}] <input type="text" id="name-${this.index}" style="width:200px;" placeholder="名称" value="${this.name}"></label>
                                <label style="margin-left:10px;">効果時間: <input type="number" id="effectDuration-${this.index}" value="${this.effectDuration}" min="1" style="width:80px;"></label>
                                <label style="margin-left:10px;">延長時間: <input type="number" id="extendDuration-${this.index}" value="${this.extendDuration}" min="1" style="width:80px;"></label>
                                <span id="time-${this.index}" style="display:inline-block;margin-left:5px;width:40px;text-align:right;">0</span> 秒
                                <button id="reset-${this.index}">リセット</button>
                                ${notesHtml}
                            </div>
                        `;
                };

                const addEventListeners = () => {
                    document.getElementById(`name-${this.index}`).addEventListener("input", (e) => {
                        this.name = e.target.value;
                    });
                    document.getElementById(`effectDuration-${this.index}`).addEventListener("change", (e) => {
                        this.effectDuration = parseInt(e.target.value) || 1;
                    });
                    document.getElementById(`extendDuration-${this.index}`).addEventListener("change", (e) => {
                        this.extendDuration = parseInt(e.target.value) || 1;
                    });
                    document.getElementById(`reset-${this.index}`).addEventListener("click", () => this.reset());
                };

                // notes取得（テンプレートから）
                let notes = '';
                const select = document.getElementById('templateSelect');
                const hornName = select && select.value;
                if (hornName && typeof huntingHornTimerTemplates === 'object' && huntingHornTimerTemplates[hornName]) {
                    const template = huntingHornTimerTemplates[hornName][this.index - 1];
                    if (template && template.notes) notes = template.notes;
                }
                const notesHtml = createNotesHtml(notes);
                div.innerHTML = createTimerRowHtml(notesHtml);
                container.appendChild(div);
                addEventListeners();
            }
        }

        // Melody配列で管理
        let melodies = [];
        const timersDiv = document.getElementById("timers");

        // テンプレート選択UIの初期化
        function initTemplateSelect() {
            if (typeof huntingHornTimerTemplates !== 'object') return;
            const select = document.getElementById('templateSelect');
            for (const hornName in huntingHornTimerTemplates) {
                const opt = document.createElement('option');
                opt.value = hornName;
                opt.textContent = hornName;
                select.appendChild(opt);
            }
        }

        // 色名→カラーコード変換
        function getHornColorCode(c) {
            switch (c) {
                case '白': return '#ffffff';
                case '赤': return '#ff0000';
                case '青': return '#0000ff';
                case '黄': return '#ffff00';
                case '緑': return '#00ff00';
                case '空': return '#75C4FF';
                case '紫': return '#ff00ff';
                case '橙': return '#FF8800';
                default: return '#ccc';
            }
        }

        // 音色表示
        function showHornColors(hornName) {
            const colorDiv = document.getElementById('hornColors');
            colorDiv.innerHTML = '';
            if (!hornName) return;
            const colors = hornName.split("").slice(0, 3);
            colors.forEach(c => {
                const span = document.createElement('span');
                span.style.display = 'inline-block';
                span.style.width = '28px';
                span.style.height = '28px';
                span.style.borderRadius = '50%';
                span.style.marginRight = '8px';
                // 色に応じてアウトライン色を変える
                let borderColor = '#222';
                if (c === '白' || c === '黄' || c === '空') borderColor = '#888';
                span.style.border = '1.5px solid ' + borderColor;
                span.style.background = getHornColorCode(c);
                span.title = c;
                colorDiv.appendChild(span);
            });
        }

        // テンプレート適用処理
        function applyTemplate() {
            const select = document.getElementById('templateSelect');
            const hornName = select.value;
            showHornColors(hornName);
            const withSkill = document.getElementById('fuefukiCheckbox').checked;
            if (!hornName || !huntingHornTimerTemplates[hornName]) return;
            const template = huntingHornTimerTemplates[hornName];
            for (let i = 0; i < 9; i++) {
                if (template[i]) {
                    melodies[i].name = template[i].name;
                    if (withSkill && template[i].effectDurationWithSkill !== undefined) {
                        melodies[i].effectDuration = parseInt(template[i].effectDurationWithSkill) || 1;
                        melodies[i].extendDuration = parseInt(template[i].extendDurationWithSkill) || 1;
                    } else {
                        melodies[i].effectDuration = parseInt(template[i].effectDuration) || 1;
                        melodies[i].extendDuration = parseInt(template[i].extendDuration) || 1;
                    }
                } else {
                    // テンプレートにない場合はデフォルト値にリセット
                    melodies[i].name = '';
                    melodies[i].effectDuration = 180;
                    melodies[i].extendDuration = 90;
                }
                melodies[i].timer = 0;
            }
            // タイマーUIを再描画
            timersDiv.innerHTML = '';
            melodies.forEach(melody => melody.render(timersDiv));
        }

        // 初期化
        window.addEventListener('DOMContentLoaded', () => {
            // 1～9の旋律タイマーを生成
            for (let i = 1; i <= 9; i++) {
                melodies.push(new Melody(i));
            }
            // UI描画
            melodies.forEach(melody => melody.render(timersDiv));
            initTemplateSelect();
            document.getElementById('applyTemplateBtn').addEventListener('click', applyTemplate);
        });

        // キーボード入力
        document.addEventListener("keydown", (e) => {
            if (!/^[1-9]$/.test(e.key)) return;
            const key = Number(e.key);
            melodies[key - 1].addTime();
        });

        // 1秒ごとに減らす
        setInterval(() => {
            melodies.forEach(melody => {
                if (melody.timer > 0) {
                    melody.timer--;
                    melody.updateUI();
                }
            });
        }, 1000);
    </script>
</body>

</html>